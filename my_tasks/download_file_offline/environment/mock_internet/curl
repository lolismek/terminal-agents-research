#!/bin/bash
# Fake curl that serves local files for specific URLs, passes through others
# This intercepts only the task URL while allowing agent installation to work

# Target URL pattern to intercept (from the instruction)
TARGET_URL_PATTERN="raw.githubusercontent.com/octobloblo/Hello-World"

# Save all original arguments
ORIGINAL_ARGS=("$@")

# Parse arguments to find URL
URL=""
for arg in "$@"; do
    case $arg in
        http://*|https://*)
            URL="$arg"
            ;;
    esac
done

# Check if this URL should be intercepted
if [[ "$URL" == *"$TARGET_URL_PATTERN"* ]]; then
    # This is the target URL - serve local file

    # Parse arguments for output file
    OUTPUT_FILE=""
    SILENT=false

    while [[ $# -gt 0 ]]; do
        case $1 in
            -o|--output)
                OUTPUT_FILE="$2"
                shift 2
                ;;
            -s|--silent)
                SILENT=true
                shift
                ;;
            *)
                shift
                ;;
        esac
    done

    # Simulate curl progress output (unless silent)
    if [ "$SILENT" = false ]; then
        echo "  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current" >&2
        echo "                                 Dload  Upload   Total   Spent    Left  Speed" >&2
        echo "100    20  100    20    0     0   2569      0 --:--:-- --:--:-- --:--:--  2591" >&2
    fi

    # Serve the local file
    LOCAL_FILE="/mock_internet/testfile.txt"

    if [ -f "$LOCAL_FILE" ]; then
        if [ -n "$OUTPUT_FILE" ]; then
            cat "$LOCAL_FILE" > "$OUTPUT_FILE"
        else
            cat "$LOCAL_FILE"
        fi
        exit 0
    else
        echo "curl: (6) Could not resolve host" >&2
        exit 6
    fi
else
    # Not the target URL - pass through to real curl
    exec /usr/bin/curl "${ORIGINAL_ARGS[@]}"
fi
